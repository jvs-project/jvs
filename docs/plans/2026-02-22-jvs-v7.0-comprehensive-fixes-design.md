# JVS v7.0 Comprehensive Fixes Design

**Date**: 2026-02-22
**Status**: Approved
**Scope**: Fix all 15 issues identified in final review

## Overview

This design addresses 15 issues across 4 priority levels to bring JVS v7.0 into full spec compliance and improve code quality.

## Changes Summary

| Priority | Count | Focus Area |
|----------|-------|------------|
| P0 Critical | 3 | Data integrity |
| P1 Important | 5 | Spec conformance |
| P2 Medium | 4 | Robustness |
| P3 Low | 3 | Quality of life |

## P0 Critical Fixes

### P0-1: Snapshot .tmp Atomic Protocol

**File**: `internal/snapshot/creator.go`

Change snapshot creation to use atomic tmp->rename pattern per 12-step protocol:

```go
// Current (wrong): Direct creation
snapshotDir := ".jvs/snapshots/" + snapshotID
os.MkdirAll(snapshotDir, 0755)

// Fixed: Atomic with .tmp
snapshotTmp := ".jvs/snapshots/" + snapshotID + ".tmp"
snapshotDir := ".jvs/snapshots/" + snapshotID

os.MkdirAll(snapshotTmp, 0755)
engine.Clone(payloadPath, snapshotTmp)
fsutil.FsyncTree(snapshotTmp)
// ... write .READY to tmp ...
os.Rename(snapshotTmp, snapshotDir)
fsutil.FsyncDir(filepath.Dir(snapshotDir))
```

### P0-2: Connect Engine Detection to CLI

**Files**: `internal/cli/snapshot.go`, `internal/cli/worktree.go`, `internal/cli/restore.go`

Replace hardcoded `model.EngineCopy` with detected engine:

```go
func getEngine(repoRoot string) model.EngineType {
    eng, _ := engine.DetectEngine(repoRoot)
    return eng.Name()
}
```

### P0-3: Audit Chain Verification in Doctor

**File**: `internal/doctor/doctor.go`

Add audit hash chain verification when `--strict` is used. Report `E_AUDIT_CHAIN_BROKEN` on mismatch.

## P1 Important Fixes

### P1-1: Add `snapshot_engine` Field to `jvs info`

**File**: `internal/cli/info.go`

Add detected engine to JSON output:
```json
{
  "snapshot_engine": "juicefs-clone|reflink-copy|copy"
}
```

### P1-2: Add fsync After Snapshot Clone

**File**: `pkg/fsutil/fsync.go` (new function)

Add `FsyncTree()` to recursively sync all files after clone.

### P1-3: Add `--force` Flag to `worktree remove`

**File**: `internal/cli/worktree.go`

Add `-f, --force` flag to allow removing worktrees in detached state.

### P1-4: Handle GC Descriptor Deletion Errors

**File**: `internal/gc/collector.go`

Log warning when descriptor deletion fails (snapshot already deleted).

### P1-5: Fix Restore Backup Cleanup Race

**File**: `internal/restore/restorer.go`

Replace untracked goroutine with defer-based synchronous cleanup with error logging.

## P2 Medium Fixes

### P2-1: Doctor `--repair-runtime` with Actions

**File**: `internal/doctor/doctor.go`

Add 5 repair actions:
- `clean_tmp`: Remove orphan .tmp files
- `clean_intents`: Remove completed intent files
- `rebuild_index`: Rebuild index from state
- `audit_repair`: Recompute audit chain
- `advance_head`: Advance stale head to latest READY

### P2-2: Fix `isOnJuiceFS()` Implementation

**File**: `internal/engine/juicefs.go`

Read `/proc/mounts` to actually check if path is on JuiceFS mount.

### P2-3: Add `candidate_count` to GC Plan

**Files**: `pkg/model/gc.go`, `internal/gc/collector.go`

Add `candidate_count` field matching spec requirement.

### P2-4: Add `error_code` to JSON Output

**File**: `internal/cli/errors.go` (new)

Add structured error output with spec-defined error codes.

## P3 Low Priority Improvements

### P3-1: Progress Callback for Long Operations

**File**: `pkg/progress/progress.go` (new)

Add progress interface for snapshot/restore operations.

### P3-2: Config File Support

**File**: `pkg/config/config.go` (new)

Support `.jvs/config.yaml` for engine, retention, logging settings.

### P3-3: `--debug` Flag with Structured Logging

**File**: `pkg/logging/logging.go` (new)

Add structured JSON logging when `--debug` is enabled.

## Implementation Order

1. **Commit 1: P0 Critical**
   - Snapshot atomic protocol
   - Engine detection connection
   - Audit chain verification

2. **Commit 2: P1 Important**
   - info fields, fsync, force flag
   - GC errors, restore cleanup

3. **Commit 3: P2 Medium**
   - Doctor repair, engine fix
   - GC candidate_count, error codes

4. **Commit 4: P3 Improvements**
   - Progress, config, logging

## Testing

- All existing tests must pass
- New tests for audit chain verification
- New tests for snapshot atomic protocol (crash simulation)
- Manual testing of engine detection on JuiceFS

## Spec Updates

Specs will be updated to match implementation when:
- Implementation is better than spec
- Spec has clear errors or omissions

No proactive additions beyond current implementation.
