---
# Install JVS from GitHub release

- name: Determine system architecture
  set_fact:
    jvs_arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else ansible_architecture }}"

- name: Set download URL based on version
  set_fact:
    jvs_download_url: "https://github.com/jvs-project/jvs/releases/{{ 'latest' if jvs_version == 'latest' else 'download/' + jvs_version }}"
    jvs_download_filename: "jvs-linux-{{ jvs_arch }}"

- name: Create temporary directory for download
  tempfile:
    state: directory
    suffix: .jvs
  register: jvs_temp_dir

- name: Download JVS binary
  get_url:
    url: "{{ jvs_download_url }}/{{ jvs_download_filename }}"
    dest: "{{ jvs_temp_dir.path }}/jvs"
    mode: '0755'
    timeout: 300
  register: jvs_download

- name: Verify downloaded binary
  command: "{{ jvs_temp_dir.path }}/jvs version"
  register: jvs_verify
  changed_when: false

- name: Install JVS binary
  copy:
    src: "{{ jvs_temp_dir.path }}/jvs"
    dest: "{{ jvs_bin_dir }}/jvs"
    mode: '0755'
    owner: "{{ jvs_user }}"
    group: "{{ jvs_group }}"
    remote_src: true
  notify: jvs installed

- name: Clean up temporary directory
  file:
    path: "{{ jvs_temp_dir.path }}"
    state: absent
  when: jvs_temp_dir.path is defined
