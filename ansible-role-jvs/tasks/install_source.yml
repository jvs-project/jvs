---
# Install JVS from source

- name: Check if Go is installed
  command: go version
  register: go_version
  changed_when: false
  failed_when: false

- name: Fail if Go is not installed
  fail:
    msg: "Go is required to build JVS from source but is not installed"
  when: go_version.rc != 0

- name: Create build directory
  tempfile:
    state: directory
    suffix: .jvs-build
  register: jvs_build_dir

- name: Clone JVS repository
  git:
    repo: https://github.com/jvs-project/jvs.git
    dest: "{{ jvs_build_dir.path }}/jvs"
    version: "{{ 'main' if jvs_version == 'source' else jvs_version }}"
    force: true

- name: Build JVS
  command: go build -o jvs ./cmd/jvs
  args:
    chdir: "{{ jvs_build_dir.path }}/jvs"
  environment:
    GOBIN: "{{ jvs_bin_dir }}"

- name: Install JVS binary
  copy:
    src: "{{ jvs_build_dir.path }}/jvs/jvs"
    dest: "{{ jvs_bin_dir }}/jvs"
    mode: '0755'
    owner: "{{ jvs_user }}"
    group: "{{ jvs_group }}"
    remote_src: true
  notify: jvs installed

- name: Clean up build directory
  file:
    path: "{{ jvs_build_dir.path }}"
    state: absent
  when: jvs_build_dir.path is defined
