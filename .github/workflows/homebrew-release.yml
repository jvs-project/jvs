name: Update Homebrew Formula

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v7.0)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  update-formula:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    steps:
      - name: Get version from release or input
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}"

      - name: Download source tarball
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          curl -L "https://github.com/jvs-project/jvs/archive/refs/tags/${VERSION}.tar.gz" -o /tmp/jvs.tar.gz

      - name: Calculate SHA256
        id: sha256
        run: |
          SHA256=$(shasum -a 256 /tmp/jvs.tar.gz | awk '{print $1}')
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT
          echo "Source SHA256: ${SHA256}"

      - name: Clone homebrew-jvs tap
        run: |
          git clone https://github.com/jvs-project/homebrew-jvs.git /tmp/homebrew-jvs
          cd /tmp/homebrew-jvs
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update formula
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SHA256="${{ steps.sha256.outputs.sha256 }}"
          cd /tmp/homebrew-jvs
          ./update-formula.sh "${VERSION}" "${SHA256}"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.JVS_BOT_TOKEN }}
          path: /tmp/homebrew-jvs
          branch: "update-jvs-${{ steps.version.outputs.version }}"
          commit-message: "Update jvs to ${{ steps.version.outputs.version }}"
          title: "Update jvs to ${{ steps.version.outputs.version }}"
          body: |
            Automated update for JVS release ${{ steps.version.outputs.version }}.

            **Changes:**
            - Version: ${{ steps.version.outputs.version }}
            - Source SHA256: ${{ steps.sha256.outputs.sha256 }}

            **To Do:**
            - [ ] Build bottles for all platforms
            - [ ] Update bottle SHA256 values
            - [ ] Test installation
            - [ ] Run `brew audit --strict --online`
          labels: automated-update
